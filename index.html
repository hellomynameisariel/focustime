<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FocusTime</title>
  <style>
    body {
      background-color: black;
      color: #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      padding: 10px;
      transition: background-color 1s, color 1s;
    }

    #popOutButton {
      background: none;
      border: none;
      color: inherit;
      font-size: 1.2em;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #popOutButton span {
      font-size: 0.7em;
      margin-top: 2px;
    }

    #status {
      margin-top: 50px;
      font-size: 1.2em;
      padding: 6px 12px;
      border-radius: 6px;
      background-color: transparent;
      text-align: center;
    }

    #timer {
      font-size: var(--timer-font-size, 12vw);
      margin-top: 20px;
      text-align: center;
    }

    .slider-label {
      margin-top: 10px;
      font-size: 0.7em;
      text-transform: lowercase;
    }

    .slider-bar {
      display: flex;
      align-items: center;
      padding: 5px 10px;
      border-radius: 8px;
      margin-top: 10px;
    }

    input[type=range] {
      width: 160px;
      background: transparent;
    }

    select {
      font-size: 1em;
      margin: 4px;
    }

    button {
      margin-top: 10px;
      font-size: 1em;
    }
  </style>
</head>
<body>

<button id="popOutButton" title="Open in new window">â†—<span>pop-out</span></button>

<div id="status">Time until next session</div>
<div id="timer">00:00</div>
<div class="slider-label" id="resizeLabel">resize</div>
<div class="slider-bar" id="sliderBar">
  <span>-</span>
  <input type="range" id="sizeSlider" min="4" max="30" value="12">
  <span>+</span>
</div>

<!-- Controls -->
<div style="margin-top: 20px; text-align: center;">
  <label>Starting time:
    <select id="hourSelect"></select>:
    <select id="minuteSelect">
      <option value="0">00</option>
      <option value="15">15</option>
      <option value="30">30</option>
      <option value="45">45</option>
    </select>
  </label>
  <label>
    Duration:
    <select id="durationSelect">
      <option value="25">25 min</option>
      <option value="50">50 min</option>
      <option value="75">75 min</option>
    </select>
  </label>
  <br>
  <button onclick="startSession()">Start Session</button>
  <button onclick="resetTimer()">Reset</button>
</div>

<script>
  const hourSelect = document.getElementById("hourSelect");
  const now = new Date();
  const hourNow = now.getHours();
  const hours12 = [(hourNow - 1 + 24) % 24, hourNow, (hourNow + 1) % 24];

  for (let h of hours12) {
    const ampm = h >= 12 ? "PM" : "AM";
    const hour12 = ((h + 11) % 12 + 1);
    const opt = new Option(`${hour12} ${ampm}`, h);
    hourSelect.appendChild(opt);
  }

  const status = document.getElementById("status");
  const timerDisplay = document.getElementById("timer");
  const sizeSlider = document.getElementById("sizeSlider");
  const resizeLabel = document.getElementById("resizeLabel");
  const sliderBar = document.getElementById("sliderBar");

  sizeSlider.addEventListener('input', () => {
    document.documentElement.style.setProperty('--timer-font-size', sizeSlider.value + 'vw');
  });

  document.getElementById("popOutButton").addEventListener("click", () => {
    const newWin = window.open(location.href, "_blank", "width=500,height=500");
  });

  function startSession() {
    const h = parseInt(hourSelect.value);
    const m = parseInt(document.getElementById("minuteSelect").value);
    const d = parseInt(document.getElementById("durationSelect").value);
    const start = new Date();
    start.setHours(h, m, 0, 0);
    const end = new Date(start.getTime() + d * 60000);

    localStorage.setItem("focusStart", start.getTime());
    localStorage.setItem("focusEnd", end.getTime());
    localStorage.setItem("focusDuration", d);

    update();
    if (!window._timerInterval) window._timerInterval = setInterval(update, 1000);
  }

  function resetTimer() {
    if (confirm("Do you really want to reset?")) {
      localStorage.clear();
      clearInterval(window._timerInterval);
      window._timerInterval = null;
      status.textContent = "Time until next session";
      timerDisplay.textContent = "00:00";
      document.body.style.backgroundColor = "#000";
      document.body.style.color = "#ccc";
    }
  }

  function update() {
    const start = parseInt(localStorage.getItem("focusStart"));
    const end = parseInt(localStorage.getItem("focusEnd"));
    const duration = parseInt(localStorage.getItem("focusDuration"));
    const now = Date.now();

    if (!start || !end || !duration) return;

    if (now < start) {
      const seconds = Math.floor((start - now) / 1000);
      if (seconds <= 120) {
        status.textContent = "Session starts in:";
        setColors("#caffbf", "#000");
      } else {
        status.textContent = "Time until next session";
        setColors("#fff3b0", "#000");
      }
      timerDisplay.textContent = formatTime(seconds);
    } else if (now < end) {
      const seconds = Math.floor((end - now) / 1000);
      status.textContent = "Time in session remaining";
      if (seconds <= 120) {
        setColors("#ffadad", "#000");
      } else {
        const progress = (duration * 60 - seconds) / (duration * 60);
        const light = Math.floor(progress * 255);
        const bg = `rgb(${light},${light},${light})`;
        const text = (light > 127) ? "#000" : "#fff";
        setColors(bg, text);
      }
      timerDisplay.textContent = formatTime(seconds);
    } else {
      const seconds = Math.floor((now - end) / 1000);
      status.textContent = "Session complete. Time since end:";
      setColors("#a0c4ff", "#000");
      timerDisplay.textContent = formatTime(seconds);
    }
  }

  function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${m}:${s.toString().padStart(2, "0")}`;
  }

  function setColors(bg, text) {
    document.body.style.backgroundColor = bg;
    document.body.style.color = text;
    resizeLabel.style.color = text;
    sliderBar.style.backgroundColor = bg;
  }

  if (localStorage.getItem("focusStart")) {
    update();
    window._timerInterval = setInterval(update, 1000);
  }
</script>

</body>
</html>
