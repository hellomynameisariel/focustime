<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FocusTime</title>
  <style>
    :root {
      --text-light: #f5f5f5;
      --text-dark: #111;
      --bg-black: #000;
      --bg-yellow: #f0e442;
      --bg-green: #a8e6cf;
      --bg-red: #d55e00;
      --bg-blue: #56b4e9;
      --bg-gray: #888;
    }

    body {
      background-color: var(--bg-black);
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      padding: 10px;
      transition: background-color 1s, color 1s;
    }

    #popOutButton {
      background: none;
      border: none;
      color: inherit;
      font-size: 1.2em;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #popOutButton span {
      font-size: 0.7em;
      margin-top: 2px;
    }

    #status {
      margin-top: 40px;
      margin-bottom: 4px;
      font-size: 1.2em;
      padding: 6px 12px;
      border-radius: 6px;
      text-align: center;
    }

    #timer {
      font-size: var(--timer-font-size, 12vw);
      margin-top: 0;
      text-align: center;
    }

    .slider-label {
      margin-top: 10px;
      font-size: 0.7em;
      text-transform: lowercase;
      transition: color 0.3s ease;
    }

    .slider-bar {
      display: flex;
      align-items: center;
      padding: 5px 10px;
      border-radius: 8px;
      margin-top: 10px;
      background-color: rgba(255, 255, 255, 0.05);
      transition: background-color 0.3s ease;
    }

    input[type=range] {
      width: 160px;
      background: transparent;
    }

    select, button {
      font-size: 1em;
      margin: 4px;
      background-color: #222;
      color: var(--text-light);
      border: 1px solid #444;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    #controls, #footer {
      margin-top: 20px;
      text-align: center;
    }

    #footer a {
      font-size: 0.7em;
      color: #888;
      text-decoration: none;
    }
  </style>
</head>
<body>

<button id="popOutButton" title="Open in new window">â†—<span>Pop-out</span></button>

<div id="status">Time until next session:</div>
<div id="timer">00:00</div>
<div class="slider-label" id="resizeLabel">Resize:</div>
<div class="slider-bar" id="sliderBar">
  <span>-</span>
  <input type="range" id="sizeSlider" min="4" max="30" value="12">
  <span>+</span>
</div>

<!-- Controls -->
<div id="controls">
  <label>Starting time:
    <select id="hourSelect"></select>:
    <select id="minuteSelect">
      <option value="0">00</option>
      <option value="15">15</option>
      <option value="30">30</option>
      <option value="45">45</option>
    </select>
  </label>
  <label>
    Duration:
    <select id="durationSelect">
      <option value="25">25 min</option>
      <option value="50">50 min</option>
      <option value="75">75 min</option>
    </select>
  </label>
  <br>
  <button onclick="startSession()">Start session</button>
</div>

<div id="resetWrapper" style="margin-top: 20px; text-align: center;">
  <button onclick="resetTimer()">Reset session</button>
</div>

<div id="footer">
  <a href="https://hellomynameisariel.github.io/flowtools/" target="_blank">See all Flow Tools by Ariel</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const hourSelect = document.getElementById("hourSelect");
  const minuteSelect = document.getElementById("minuteSelect");

  const now = new Date();
  const currentHour = now.getHours();
  const currentMinutes = now.getMinutes();

  // Find next quarter hour (rounding up)
  let nextMinutes = [0, 15, 30, 45].find(m => m > currentMinutes);
  let hour = currentHour;

  if (nextMinutes === undefined) {
    nextMinutes = 0;
    hour = (hour + 1) % 24;
  }

  // Build hour options: -1, current, +1
  const hourOptions = [
    (hour - 1 + 24) % 24,
    hour,
    (hour + 1) % 24
  ];

  hourOptions.forEach(h => {
    const ampm = h >= 12 ? "PM" : "AM";
    const hour12 = ((h + 11) % 12 + 1);
    const opt = new Option(`${hour12} ${ampm}`, h);
    hourSelect.appendChild(opt);
  });

  hourSelect.value = hour;
  minuteSelect.value = nextMinutes;

  // Set visible contrast styles for initial black background
  resizeLabel.style.color = "#f5f5f5";
  sliderBar.style.backgroundColor = "rgba(255, 255, 255, 0.05)";
});

const status = document.getElementById("status");
const timerDisplay = document.getElementById("timer");
const sizeSlider = document.getElementById("sizeSlider");
const resizeLabel = document.getElementById("resizeLabel");
const sliderBar = document.getElementById("sliderBar");

sizeSlider.addEventListener('input', () => {
  document.documentElement.style.setProperty('--timer-font-size', sizeSlider.value + 'vw');
});

document.getElementById("popOutButton").addEventListener("click", () => {
  const newWin = window.open(location.href, "_blank", "width=500,height=500");
});

function startSession() {
  const h = parseInt(document.getElementById("hourSelect").value);
  const m = parseInt(document.getElementById("minuteSelect").value);
  const d = parseInt(document.getElementById("durationSelect").value);
  const start = new Date();
  start.setHours(h, m, 0, 0);
  const end = new Date(start.getTime() + d * 60000);

  localStorage.setItem("focusStart", start.getTime());
  localStorage.setItem("focusEnd", end.getTime());
  localStorage.setItem("focusDuration", d);

  document.getElementById("controls").style.display = "none";
  update();
  if (!window._timerInterval) window._timerInterval = setInterval(update, 1000);
}

function resetTimer() {
  if (confirm("Do you really want to reset?")) {
    localStorage.clear();
    clearInterval(window._timerInterval);
    window._timerInterval = null;
    document.getElementById("controls").style.display = "block";
    status.textContent = "Time until next session:";
    timerDisplay.textContent = "00:00";
    document.body.style.backgroundColor = "#000";
    document.body.style.color = "#ccc";
    resizeLabel.style.color = "#f5f5f5";
    sliderBar.style.backgroundColor = "rgba(255,255,255,0.05)";
  }
}

function update() {
  const start = parseInt(localStorage.getItem("focusStart"));
  const end = parseInt(localStorage.getItem("focusEnd"));
  const duration = parseInt(localStorage.getItem("focusDuration"));
  const now = Date.now();

  if (!start || !end || !duration) return;

  if (now < start) {
    const seconds = Math.floor((start - now) / 1000);
    if (seconds <= 120) {
      status.textContent = "Session starts in:";
      setColors("--bg-green", "--text-dark");
    } else {
      status.textContent = "Time until next session:";
      setColors("--bg-yellow", "--text-dark");
    }
    timerDisplay.textContent = formatTime(seconds);
  } else if (now < end) {
    const seconds = Math.floor((end - now) / 1000);
    status.textContent = "Time in session remaining:";
    if (seconds <= 120) {
      setColors("--bg-red", "--text-light");
    } else {
      const progress = (duration * 60 - seconds) / (duration * 60);
      const val = Math.floor(progress * 255);
      const bg = `rgb(${val},${val},${val})`;
      const text = (val > 127) ? "#000" : "#fff";
      document.body.style.backgroundColor = bg;
      document.body.style.color = text;
      resizeLabel.style.color = text;
      sliderBar.style.backgroundColor = (val > 127) ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.1)';
    }
    timerDisplay.textContent = formatTime(seconds);
  } else {
    const seconds = Math.floor((now - end) / 1000);
    status.textContent = "Session complete. Time since end:";
    setColors("--bg-blue", "--text-dark");
    timerDisplay.textContent = formatTime(seconds);
  }
}

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${s.toString().padStart(2, "0")}`;
}

function setColors(bgVar, textVar) {
  const bg = getComputedStyle(document.documentElement).getPropertyValue(bgVar).trim();
  const text = getComputedStyle(document.documentElement).getPropertyValue(textVar).trim();
  document.body.style.backgroundColor = bg;
  document.body.style.color = text;
  setContrastStyles(bg);
}

function setContrastStyles(bgColor) {
  const r = parseInt(bgColor.slice(1, 3), 16);
  const g = parseInt(bgColor.slice(3, 5), 16);
  const b = parseInt(bgColor.slice(5, 7), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;

  const contrastText = brightness > 140 ? '#111' : '#f5f5f5';
  const contrastBar = brightness > 140 ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.1)';

  document.body.style.color = contrastText;
  resizeLabel.style.color = contrastText;
  sliderBar.style.backgroundColor = contrastBar;
}

if (localStorage.getItem("focusStart")) {
  document.getElementById("controls").style.display = "none";
  update();
  window._timerInterval = setInterval(update, 1000);
}
</script>


</body>
</html>
